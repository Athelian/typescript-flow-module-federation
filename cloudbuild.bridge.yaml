####################################
# Branch develop deploy to staging #
####################################
name: 'Deploy Staging'
triggers:
- branches: ['develop']
steps:
- name: 'gcr.io/cloud-builders/gsutil'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      gsutil cp gs://zenport-gcb-bridge/cache/web-app-develop_node_modules.tar.gz node_modules.tar.gz || true
      if [ -e node_modules.tar.gz ]; then
        tar -xzf node_modules.tar.gz
      fi
- name: 'node:10.15.3'
  entrypoint: yarn
  args: ['install']
- name: 'gcr.io/cloud-builders/gsutil'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      tar -czf node_modules.tar.gz node_modules
      gsutil cp node_modules.tar.gz gs://zenport-gcb-bridge/cache/web-app-develop_node_modules.tar.gz
- name: 'node:10.15.3'
  entrypoint: yarn
  args: ['build:stg']
  env: ['ZENPORT_FIREBASE_DEPLOY_REVISION=$SHORT_SHA']
- name: 'gcr.io/zenport-183806/firebase'
  args: ['deploy', '--only', 'hosting:staging']
  secretEnv: ['FIREBASE_TOKEN']
- name: 'gcr.io/zenport-183806/firebase'
  args: ['database:set', '/revision_staging', '--data', "\"$SHORT_SHA\"", '--confirm']
  secretEnv: ['FIREBASE_TOKEN']
secrets:
- kmsKeyName: 'projects/zenport-183806/locations/global/keyRings/cloudbuild/cryptoKeys/FIREBASE_TOKEN'
  secretEnv:
    FIREBASE_TOKEN: 'CiQABMiRS2pzGQzkQpV9nxSXoJ2JJasJwnByeP5/LkT1BvD480USVgBl1o1Vk8mKYamYIoTV+nKp3ioXT69W8uWUke0duMu48TPBE2kNHEU6lDETMssT8Mw7rPaATUsLDb69WA5MhmvpdXHz2nOavdjM9ZfWa/ZoV9Bcvp83'
timeout: 1200s
---
#########################################
# Branch hotfixes deploy to staging-hot #
#########################################
name: 'Deploy Staging Hotfixes'
triggers:
  - branches: ['hotfixes']
steps:
  - name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gsutil cp gs://zenport-gcb-bridge/cache/web-app-hotfixes_node_modules.tar.gz node_modules.tar.gz || true
        if [ -e node_modules.tar.gz ]; then
          tar -xzf node_modules.tar.gz
        fi
  - name: 'node:10.15.3'
    entrypoint: yarn
    args: ['install']
  - name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        tar -czf node_modules.tar.gz node_modules
        gsutil cp node_modules.tar.gz gs://zenport-gcb-bridge/cache/web-app-hotfixes_node_modules.tar.gz
  - name: 'node:10.15.3'
    entrypoint: yarn
    args: ['build:stg']
    env:
      - 'ZENPORT_FIREBASE_DEPLOY_REVISION=$SHORT_SHA'
      - 'ZENPORT_FIREBASE_REVISION_KEY=revision_staging_hot'
  - name: 'gcr.io/zenport-183806/firebase'
    args: ['deploy', '--only', 'hosting:staging-hot']
    secretEnv: ['FIREBASE_TOKEN']
  - name: 'gcr.io/zenport-183806/firebase'
    args: ['database:set', '/revision_staging_hot', '--data', "\"$SHORT_SHA\"", '--confirm']
    secretEnv: ['FIREBASE_TOKEN']
secrets:
  - kmsKeyName: 'projects/zenport-183806/locations/global/keyRings/cloudbuild/cryptoKeys/FIREBASE_TOKEN'
    secretEnv:
      FIREBASE_TOKEN: 'CiQABMiRS2pzGQzkQpV9nxSXoJ2JJasJwnByeP5/LkT1BvD480USVgBl1o1Vk8mKYamYIoTV+nKp3ioXT69W8uWUke0duMu48TPBE2kNHEU6lDETMssT8Mw7rPaATUsLDb69WA5MhmvpdXHz2nOavdjM9ZfWa/ZoV9Bcvp83'
timeout: 1200s
---
######################################
# Branch master deploy to production #
######################################
name: 'Deploy Prod'
triggers:
  - branches: ['master']
steps:
  - name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gsutil cp gs://zenport-gcb-bridge/cache/web-app-master_node_modules.tar.gz node_modules.tar.gz || true
        if [ -e node_modules.tar.gz ]; then
          tar -xzf node_modules.tar.gz
        fi
  - name: 'node:10.15.3'
    entrypoint: yarn
    args: ['install']
  - name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        tar -czf node_modules.tar.gz node_modules
        gsutil cp node_modules.tar.gz gs://zenport-gcb-bridge/cache/web-app-master_node_modules.tar.gz
  - name: 'node:10.15.3'
    entrypoint: yarn
    args: ['build:prod']
    env: ['ZENPORT_FIREBASE_DEPLOY_REVISION=$SHORT_SHA']
  - name: 'gcr.io/zenport-183806/firebase'
    args: ['deploy', '--only', 'hosting:prod']
    secretEnv: ['FIREBASE_TOKEN']
  - name: 'gcr.io/zenport-183806/firebase'
    args: ['database:set', '/revision_production', '--data', "\"$SHORT_SHA\"", '--confirm']
    secretEnv: ['FIREBASE_TOKEN']
secrets:
  - kmsKeyName: 'projects/zenport-183806/locations/global/keyRings/cloudbuild/cryptoKeys/FIREBASE_TOKEN'
    secretEnv:
      FIREBASE_TOKEN: 'CiQABMiRS2pzGQzkQpV9nxSXoJ2JJasJwnByeP5/LkT1BvD480USVgBl1o1Vk8mKYamYIoTV+nKp3ioXT69W8uWUke0duMu48TPBE2kNHEU6lDETMssT8Mw7rPaATUsLDb69WA5MhmvpdXHz2nOavdjM9ZfWa/ZoV9Bcvp83'
timeout: 1200s
